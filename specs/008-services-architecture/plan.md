# Implementation Plan: Services Architecture Refactor

**Branch**: `008-services-architecture` | **Date**: 2026-01-05 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/008-services-architecture/spec.md`

## Summary

Refactor Farmer Code from a modular Python architecture to a services-based architecture with three service types: Orchestrator Service (workflow management), Agent Hub Service (agent coordination), and Agent Services (stateless SDK-based agents). Services communicate via REST APIs, use SQLite for state persistence, and deploy via Docker Compose.

## Technical Context

**Language/Version**: Python 3.11+
**Primary Dependencies**: FastAPI, Claude Code SDK (claude-code-sdk), Pydantic v2, httpx, SQLAlchemy
**Storage**: SQLite (local), JSONL for audit logs
**Testing**: pytest with pytest-asyncio, httpx for integration tests
**Target Platform**: Docker containers (Linux), local development on macOS/Linux
**Project Type**: Multi-service (services/)
**Performance Goals**: <1s overhead for agent-to-agent communication, 60s service startup
**Constraints**: Services run on same network (localhost or EKS), no cloud dependencies
**Scale/Scope**: 3-5 concurrent workflows, 10 concurrent agent invocations

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

| Principle | Status | Notes |
|-----------|--------|-------|
| I. Test-First Development | PASS | Tests written before implementation per TDD workflow |
| II. Specification-Driven | PASS | spec.md complete with 15 FRs, 7 user stories |
| III. Independent User Stories | PASS | Stories prioritized P1-P3, independently testable |
| IV. Human Approval Gates | PASS | Plan requires approval before tasks |
| V. Parallel-First Execution | PASS | Services can be developed in parallel |
| VI. Simplicity and YAGNI | PASS | SQLite not Redis, Docker Compose not K8s |
| VII. Versioning | PASS | Conventional commits, semantic versioning |
| VIII. Technology Stack | PASS | FastAPI, Pydantic, SQLite per constitution |
| IX. Thin Client | PASS | All business logic in services |
| X. Security-First | PASS | .env for secrets, Pydantic validation |
| XI. Documentation | PASS | User journeys mapped below |
| XII. CI/CD | PASS | E2E tests required before merge |

## Project Structure

### Documentation (this feature)

```text
specs/008-services-architecture/
├── spec.md              # Feature specification
├── plan.md              # This file
├── research.md          # Research findings
├── data-model.md        # Data models
├── quickstart.md        # Validation guide
├── contracts/           # OpenAPI specifications
│   ├── orchestrator.yaml
│   ├── agent-hub.yaml
│   └── agent-service.yaml
├── checklists/
│   └── requirements.md  # Spec quality checklist
└── tasks.md             # Generated by /speckit.tasks
```

### Source Code (repository root)

```text
services/
├── orchestrator/                    # Orchestrator Service
│   ├── src/
│   │   ├── __init__.py
│   │   ├── main.py                 # FastAPI app
│   │   ├── api/
│   │   │   ├── __init__.py
│   │   │   ├── workflows.py        # /workflows endpoints
│   │   │   └── health.py           # /health endpoint
│   │   ├── core/
│   │   │   ├── __init__.py
│   │   │   ├── state_machine.py    # Workflow state management
│   │   │   └── phase_executor.py   # Phase execution logic
│   │   ├── db/
│   │   │   ├── __init__.py
│   │   │   ├── models.py           # SQLAlchemy models
│   │   │   └── session.py          # Database session
│   │   └── clients/
│   │       └── agent_hub.py        # Agent Hub HTTP client
│   ├── tests/
│   │   ├── unit/
│   │   ├── integration/
│   │   └── conftest.py
│   ├── Dockerfile
│   └── pyproject.toml
│
├── agent-hub/                       # Agent Hub Service
│   ├── src/
│   │   ├── __init__.py
│   │   ├── main.py                 # FastAPI app
│   │   ├── api/
│   │   │   ├── __init__.py
│   │   │   ├── invoke.py           # /invoke/{agent} endpoints
│   │   │   ├── ask.py              # /ask/{topic} endpoints
│   │   │   ├── escalations.py      # /escalations endpoints
│   │   │   ├── sessions.py         # /sessions endpoints
│   │   │   └── health.py           # /health endpoint
│   │   ├── core/
│   │   │   ├── __init__.py
│   │   │   ├── router.py           # Agent routing logic
│   │   │   ├── validator.py        # Confidence validation
│   │   │   ├── session_manager.py  # Session management
│   │   │   └── escalation.py       # Escalation handling
│   │   ├── db/
│   │   │   ├── __init__.py
│   │   │   ├── models.py           # SQLAlchemy models
│   │   │   └── session.py          # Database session
│   │   ├── logging/
│   │   │   └── audit.py            # JSONL audit logger
│   │   └── clients/
│   │       ├── agents.py           # Agent service HTTP clients
│   │       └── github.py           # GitHub API client (escalation)
│   ├── tests/
│   ├── Dockerfile
│   └── pyproject.toml
│
├── agents/
│   ├── baron/                       # Baron Agent Service
│   │   ├── src/
│   │   │   ├── __init__.py
│   │   │   ├── main.py             # FastAPI app
│   │   │   ├── api/
│   │   │   │   ├── invoke.py       # /invoke endpoint
│   │   │   │   └── health.py       # /health endpoint
│   │   │   ├── core/
│   │   │   │   ├── agent.py        # SDK agent wrapper
│   │   │   │   └── prompts.py      # System prompts
│   │   │   └── tools/              # Custom MCP tools
│   │   ├── tests/
│   │   ├── Dockerfile
│   │   └── pyproject.toml
│   │
│   ├── duc/                         # Duc Agent Service (architecture)
│   │   └── [same structure as baron]
│   │
│   └── marie/                       # Marie Agent Service (testing)
│       └── [same structure as baron]
│
└── shared/                          # Shared contracts package
    ├── src/contracts/
    │   ├── __init__.py
    │   ├── models/
    │   │   ├── __init__.py
    │   │   ├── workflow.py         # Workflow models
    │   │   ├── session.py          # Session models
    │   │   ├── escalation.py       # Escalation models
    │   │   └── agent.py            # Agent request/response models
    │   └── clients/
    │       ├── __init__.py
    │       ├── orchestrator.py     # Orchestrator client
    │       ├── agent_hub.py        # Agent Hub client
    │       └── agent.py            # Generic agent client
    └── pyproject.toml

tests/
├── e2e/
│   └── test_services_e2e.py        # End-to-end service tests

docker-compose.yml                   # Multi-service orchestration
```

**Structure Decision**: Multi-service architecture with dedicated services/ directory. Each service has its own tests, Dockerfile, and pyproject.toml for independent deployment. Shared contracts in services/shared/ prevent duplication.

## User Journey Mapping (REQUIRED per Constitution Principle XI)

**Journey Domain**: SVC (Services Architecture)

Map each user story to its corresponding user journey:

| User Story | Journey ID | Journey Name | Priority |
|------------|------------|--------------|----------|
| US1: Orchestrator Invokes Agent via Agent Hub | SVC-001 | Orchestrator Workflow Execution | P1 |
| US2: Agent-to-Agent Communication | SVC-002 | Expert Agent Consultation | P1 |
| US3: Human Escalation via GitHub Comments | SVC-003 | Human Review Escalation | P2 |
| US4: Session Management for Multi-Turn Conversations | SVC-004 | Multi-Turn Session | P2 |
| US5: Stateless Agent Services | SVC-005 | Stateless Agent Invocation | P1 |
| US6: Local Development with Docker Compose | SVC-006 | Local Development Setup | P3 |
| US7: Audit Logging for All Agent Exchanges | SVC-007 | Audit Log Query | P3 |

**Journey Files to Create**:
- `docs/user-journeys/SVC-001-orchestrator-workflow.md`
- `docs/user-journeys/SVC-002-agent-consultation.md`
- `docs/user-journeys/SVC-003-human-escalation.md`
- `docs/user-journeys/SVC-004-multi-turn-session.md`
- `docs/user-journeys/SVC-005-stateless-agent.md`
- `docs/user-journeys/SVC-006-local-dev-setup.md`
- `docs/user-journeys/SVC-007-audit-log-query.md`
- Update `docs/user-journeys/JOURNEYS.md`

**E2E Test Markers**:
- Each E2E test class should be marked with `@pytest.mark.journey("SVC-NNN")`

## Complexity Tracking

> No violations - architecture follows constitution principles.

| Violation | Why Needed | Simpler Alternative Rejected Because |
|-----------|------------|-------------------------------------|
| N/A | N/A | N/A |

## Documentation Strategy

### Obsolete Documentation (to be DELETED/DEPRECATED)

The following docs reference the **old module-based architecture** and will be removed or deprecated:

**DELETE** (after services are complete):
- `docs/modules/orchestrator.md` - Replaced by services/orchestrator/
- `docs/modules/agent-hub.md` - Replaced by services/agent-hub/
- `docs/modules/README.md` - Module index no longer applicable
- `docs/architecture/module-interactions.md` - Module interactions replaced by service APIs

**DEPRECATE** (mark as legacy):
- `docs/user-journeys/AH-*` - Agent Hub module journeys → SVC-* service journeys
- `docs/user-journeys/BRN-*` - Baron module journeys → SVC-* service journeys
- `docs/user-journeys/ORC-*` - Orchestrator module journeys → SVC-* service journeys

**KEEP** (still valid):
- `docs/modules/github-integration.md` - GitHub API wrapper unchanged
- `docs/modules/worktree-manager.md` - Git operations unchanged
- `docs/user-journeys/WT-*` - Worktree journeys unchanged
- `docs/getting-started/*` - Update with services setup
- `docs/testing/*` - Update with services testing
- `docs/configuration/*` - Update with services config

### New Documentation (to be CREATED per phase)

| Phase | Documentation to Create |
|-------|------------------------|
| Phase 0 | Deprecation notices on old module docs |
| Phase 1 | `docs/services/agent-hub.md`, `docs/services/agents/baron.md`, SVC-001/002/005 journeys |
| Phase 2 | `docs/services/orchestrator.md`, update architecture diagrams |
| Phase 3 | SVC-003/004 journeys, escalation flow docs |
| Phase 4 | `docs/services/README.md`, docker-compose guide, SVC-006/007 journeys |
| Final | Remove deprecated docs, update JOURNEYS.md |

## Implementation Phases

### Phase 0: Documentation Cleanup (Pre-Implementation)

**Focus**: Prepare docs for services transition

1. **Add Deprecation Notices** to old module docs:
   - `docs/modules/orchestrator.md` - Add banner: "DEPRECATED: See docs/services/orchestrator.md"
   - `docs/modules/agent-hub.md` - Add banner: "DEPRECATED: See docs/services/agent-hub.md"

2. **Create Services Doc Structure**:
   ```
   docs/services/
   ├── README.md              # Services overview
   ├── orchestrator.md        # Orchestrator Service
   ├── agent-hub.md           # Agent Hub Service
   └── agents/
       ├── README.md          # Agent services overview
       ├── baron.md           # Baron Agent
       ├── duc.md             # Duc Agent
       └── marie.md           # Marie Agent
   ```

3. **Update Architecture Overview**:
   - `docs/architecture/system-overview.md` - Add services architecture diagram
   - `docs/architecture/README.md` - Reference new services docs

---

### Phase 1: Foundation (P1 Stories - US1, US2, US5)

**Focus**: Core service communication and stateless agents

**Implementation**:

1. **Shared Contracts Package** (services/shared/)
   - Pydantic models for all request/response types
   - HTTP clients for service-to-service communication
   - Shared configuration loading

2. **Agent Hub Service** (services/agent-hub/)
   - `/invoke/{agent}` endpoint
   - `/ask/{topic}` endpoint with routing logic
   - Confidence validation
   - SQLite session storage

3. **Baron Agent Service** (services/agents/baron/)
   - `/invoke` endpoint with SDK integration
   - `/health` endpoint
   - System prompts for specify, plan, tasks workflows

4. **Integration Tests**
   - Agent Hub → Baron communication
   - Confidence validation behavior

**Documentation (end of Phase 1)**:

1. **Create Service Docs**:
   - `docs/services/agent-hub.md` - API reference, configuration, examples
   - `docs/services/agents/baron.md` - Baron service docs
   - `docs/services/agents/README.md` - Agent services overview

2. **Create User Journeys**:
   - `docs/user-journeys/SVC-001-orchestrator-workflow.md`
   - `docs/user-journeys/SVC-002-agent-consultation.md`
   - `docs/user-journeys/SVC-005-stateless-agent.md`

3. **Update Architecture**:
   - `docs/architecture/services-architecture.md` - New services diagram

---

### Phase 2: Orchestration (P1 Story - US1 continued)

**Focus**: Workflow state management and orchestration

**Implementation**:

1. **Orchestrator Service** (services/orchestrator/)
   - `/workflows` CRUD endpoints
   - State machine with SQLite persistence
   - Phase executor invoking Agent Hub

2. **End-to-End Flow**
   - Workflow creation → Agent Hub → Baron → Result

**Documentation (end of Phase 2)**:

1. **Create Service Docs**:
   - `docs/services/orchestrator.md` - Workflow API, state machine, examples

2. **Update Architecture**:
   - `docs/architecture/system-overview.md` - Replace module diagram with services
   - `docs/architecture/orchestration-flow.md` - Update for services

3. **Update Getting Started**:
   - `docs/getting-started/quickstart.md` - Services-based setup

---

### Phase 3: Sessions and Escalation (P2 Stories - US3, US4)

**Focus**: Multi-turn conversations and human escalation

**Implementation**:

1. **Session Management**
   - `/sessions` endpoints
   - Session persistence in SQLite
   - Context preservation across messages

2. **Escalation Workflow**
   - `/escalations` endpoints
   - GitHub comment integration
   - Human response processing

**Documentation (end of Phase 3)**:

1. **Create User Journeys**:
   - `docs/user-journeys/SVC-003-human-escalation.md`
   - `docs/user-journeys/SVC-004-multi-turn-session.md`

2. **Update Service Docs**:
   - `docs/services/agent-hub.md` - Add sessions and escalation sections

---

### Phase 4: DevEx and Audit (P3 Stories - US6, US7)

**Focus**: Developer experience and observability

**Implementation**:

1. **Docker Compose**
   - Multi-service docker-compose.yml
   - Service dependencies
   - Volume mounts for development

2. **Audit Logging**
   - JSONL append-only logging
   - Feature-based log queries

3. **Additional Agents**
   - Duc agent service
   - Marie agent service

**Documentation (end of Phase 4)**:

1. **Create Service Docs**:
   - `docs/services/README.md` - Complete services overview
   - `docs/services/agents/duc.md` - Duc agent docs
   - `docs/services/agents/marie.md` - Marie agent docs

2. **Create User Journeys**:
   - `docs/user-journeys/SVC-006-local-dev-setup.md`
   - `docs/user-journeys/SVC-007-audit-log-query.md`

3. **Update Configuration**:
   - `docs/configuration/environment-variables.md` - Services env vars
   - `docs/configuration/README.md` - Docker Compose config

4. **Update Testing**:
   - `docs/testing/running-tests.md` - Services test commands
   - `docs/testing/writing-tests.md` - Services test patterns

---

### Phase 5: Cleanup (Post-Implementation)

**Focus**: Remove deprecated documentation

1. **Delete Obsolete Module Docs**:
   - `docs/modules/orchestrator.md`
   - `docs/modules/agent-hub.md`
   - `docs/modules/README.md`
   - `docs/architecture/module-interactions.md`

2. **Archive Old Journeys** (move to docs/archive/):
   - `docs/user-journeys/AH-*.md`
   - `docs/user-journeys/BRN-*.md`
   - `docs/user-journeys/ORC-*.md` (except ORC-001, ORC-005 if still valid)

3. **Update Journey Registry**:
   - `docs/user-journeys/JOURNEYS.md` - Replace module journeys with SVC-* journeys

4. **Final Verification**:
   - All links in docs point to valid pages
   - No references to old src/orchestrator or src/agent_hub
   - README.md entry point updated for services

## Technology Decisions

| Decision | Choice | Rationale |
|----------|--------|-----------|
| HTTP Framework | FastAPI | Constitution requirement, async support |
| Agent SDK | claude-code-sdk | Direct SDK vs CLI subprocess |
| Database | SQLite | Local-first, no external dependencies |
| HTTP Client | httpx | Async support, type safety |
| Container | Docker | Constitution requirement |
| Orchestration | Docker Compose | Simple, sufficient for current scale |

## Migration Strategy

1. **Build new services in services/ directory** - No changes to existing src/
2. **Test services independently** - E2E tests validate service contracts
3. **Update SpecKit commands to use services** - Point to new endpoints
4. **Deprecate old modules** - Mark src/orchestrator, src/agent_hub as legacy
5. **Remove old modules** - After all tests pass on services

## Related Documentation

- **Specification**: [spec.md](./spec.md)
- **Research**: [research.md](./research.md)
- **Data Model**: [data-model.md](./data-model.md)
- **Quickstart**: [quickstart.md](./quickstart.md)
- **API Contracts**:
  - [Orchestrator API](./contracts/orchestrator.yaml)
  - [Agent Hub API](./contracts/agent-hub.yaml)
  - [Agent Service API](./contracts/agent-service.yaml)
